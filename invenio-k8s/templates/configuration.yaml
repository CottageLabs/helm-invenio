---
apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
data:
  haproxy.cfg: |
    global
      quiet

    defaults
      mode http
      maxconn 3000

      stats enable
      stats uri /stats
      stats hide-version

      timeout  http-request 10s
      timeout  queue 2m
      timeout  connect 10s
      timeout  client 2m
      timeout  server 2m
      timeout  http-keep-alive 10s
      timeout  check 10s

    frontend public
      bind *:8080
      default_backend apps

    backend apps
      server nginx nginx:80 check maxconn {{ .Values.haproxy.maxconn }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  invenio.conf: |
    upstream web {
        server web:5000 max_conns={{ .Values.nginx.max_conns }};
    }
    log_format trace '$remote_addr - $time_iso8601 "$request" '
        '$status  $body_bytes_sent $request_length "$http_referer"  '
        '"$http_user_agent" "$http_x_forwarded_for" rid=$request_id '
        'rt=$request_time uct="$upstream_connect_time" '
        'uht="$upstream_header_time" urt="$upstream_response_time" '
        'sid=$upstream_http_x_session_id uid=$upstream_http_x_user_id';

    access_log  /var/log/nginx/access.log  trace;

    server {
        listen 8080;
        server_name localhost;
        charset utf-8;

        location /ping {
            access_log off;
            return 200 "ok\n";
        }

        location / {
            include uwsgi_params;
            uwsgi_pass web;
            uwsgi_param X-Real-IP $remote_addr;
            # Sets buffering off since it creates download problems
            # when clients are slow to consume the buffer which uwsgi
            # creates by default (1GB). As a result uwsgi times out
            # by the time the client consumed the buffer.
            uwsgi_buffering off;
            uwsgi_request_buffering off;
            uwsgi_param Host $host;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            uwsgi_ignore_headers Set-Cookie;
        }
        location /static {
          alias /opt/invenio/var/instance/static/;
          autoindex off;
        }
    }
